<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APACHE II Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./static/css/calculator.css">
</head>
<body class="bg-slate-100 min-h-screen py-10 px-4">
    <div class="calculator-shell mx-auto w-full max-w-6xl space-y-10">
        <header class="page-hero">
            <div class="hero-pills">
                <span class="badge badge--outline">Benchmark mode</span>
                <span class="badge badge--neutral">APACHE II</span>
            </div>
            <h1 class="page-title">ICU Severity Wizard</h1>
            <p class="page-subtitle">
                March through the four steps—Profile, Organ support, Vitals, and Labs. Each card keeps existing
                IDs so the scoring engine remains untouched, but the layout better mirrors an ICU checklist.
            </p>
            <div class="hero-metadata">
                <div>
                    <p class="meta-label">Steps</p>
                    <p class="meta-value">4 panels</p>
                </div>
                <div>
                    <p class="meta-label">Inputs</p>
                    <p class="meta-value">16 numeric · 4 toggles</p>
                </div>
                <div>
                    <p class="meta-label">Output</p>
                    <p class="meta-value">APACHE II score</p>
                </div>
            </div>
        </header>

        <div class="split-layout">
            <section class="layout-primary">
                <form id="apache-form" class="stacked-form" novalidate>
                    <div id="error-message" class="hidden callout callout-error">
                        <div class="callout-header">
                            <span id="error-text">Please review the highlighted fields.</span>
                        </div>
                    </div>

                    <ol class="stepper">
                        <li class="step-card">
                            <div class="step-header">
                                <span class="step-index">1</span>
                                <div>
                                    <h3>Patient profile</h3>
                                    <p class="helper-text">Age, neurologic status, FiO₂, and temperature.</p>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-3 gap-6 mt-4">
                                <div>
                                    <label for="age" class="field-label">Age (years)</label>
                                    <input type="number" id="age" min="0" step="1" class="form-input" placeholder="e.g., 64" required>
                                </div>
                                <div>
                                    <label for="gcs" class="field-label">Glasgow Coma Scale</label>
                                    <input type="number" id="gcs" min="3" max="15" step="1" class="form-input" placeholder="1–15" required>
                                    <p class="helper-text">Use total GCS (3–15).</p>
                                </div>
                                <div>
                                    <label for="fio2" class="field-label">FiO₂ (%)</label>
                                    <input type="number" id="fio2" min="21" max="100" step="1" class="form-input" placeholder="e.g., 40" required>
                                    <p class="helper-text">≥ 50% switches to A–a gradient.</p>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-3 gap-6 mt-4">
                                <div>
                                    <label for="temperature" class="field-label">Temperature</label>
                                    <div class="unit-input-group mt-1">
                                        <div class="field-combo">
                                            <input type="number" id="temperature" step="any" class="combo-input" placeholder="e.g., 37.2" required>
                                        </div>
                                        <input type="hidden" id="temperature-unit" value="celsius">
                                        <div class="unit-toggle" role="group" aria-label="Temperature units">
                                            <button type="button" class="unit-chip is-active" data-temperature-unit="celsius" aria-pressed="true">°C (Celsius)</button>
                                            <button type="button" class="unit-chip" data-temperature-unit="fahrenheit" aria-pressed="false">°F (Fahrenheit)</button>
                                        </div>
                                    </div>
                                    <p class="helper-text">Toggle between °C/°F — we'll convert the value automatically.</p>
                                </div>
                                <div>
                                    <label for="paO2" class="field-label">PaO₂ (mm Hg)</label>
                                    <input type="number" id="paO2" step="1" min="0" class="form-input" placeholder="Shown when FiO₂ < 50%">
                                </div>
                                <div>
                                    <label for="aa-gradient" class="field-label">A–a gradient (mm Hg)</label>
                                    <input type="number" id="aa-gradient" step="1" min="0" class="form-input" placeholder="Shown when FiO₂ ≥ 50%">
                                </div>
                            </div>
                        </li>

                        <li class="step-card">
                            <div class="step-header">
                                <span class="step-index">2</span>
                                <div>
                                    <h3>Organ support</h3>
                                    <p class="helper-text">Flags for chronic organ failure and recent surgery.</p>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6 mt-4">
                                <div>
                                    <label class="field-label mb-2">Organ failure / immunocompromise</label>
                                    <div class="radio-toggle">
                                        <input type="radio" id="ofi-yes" name="ofi" value="true">
                                        <label for="ofi-yes">Yes</label>
                                        <input type="radio" id="ofi-no" name="ofi" value="false" checked>
                                        <label for="ofi-no">No</label>
                                    </div>
                                    <div id="surgery-type-wrapper" class="mt-3 hidden">
                                        <label for="surgery-type" class="field-label">Surgery category</label>
                                        <select id="surgery-type" class="form-input">
                                            <option value="Nonoperative">Nonoperative</option>
                                            <option value="Emergency">Emergency postop</option>
                                            <option value="Elective">Elective postop</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <span class="field-label mb-2 block">Renal failure status</span>
                                    <div class="space-y-2">
                                        <label class="flex items-center gap-2 text-sm text-gray-700">
                                            <input type="checkbox" id="acute-renal"> Acute renal failure
                                        </label>
                                        <label class="flex items-center gap-2 text-sm text-gray-700">
                                            <input type="checkbox" id="chronic-renal"> Chronic renal failure
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </li>

                        <li class="step-card">
                            <div class="step-header">
                                <span class="step-index">3</span>
                                <div>
                                    <h3>Vital signs</h3>
                                    <p class="helper-text">Capture the worst values from the first 24 hours.</p>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6 mt-4">
                                <div>
                                    <label for="heart-rate" class="field-label">Heart rate (beats/min)</label>
                                    <input type="number" id="heart-rate" min="1" class="form-input" placeholder="e.g., 96" required>
                                </div>
                                <div>
                                    <label for="resp-rate" class="field-label">Respiratory rate (breaths/min)</label>
                                    <input type="number" id="resp-rate" min="1" class="form-input" placeholder="e.g., 18" required>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6 mt-4">
                                <div class="md:col-span-2">
                                    <label for="ph" class="field-label">Arterial pH</label>
                                    <input type="number" id="ph" min="6.8" max="7.8" step="any" class="form-input" placeholder="e.g., 7.40" required>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6 mt-4">
                                <div>
                                    <label for="sbp" class="field-label">Systolic BP (mm Hg)</label>
                                    <input type="number" id="sbp" min="0" class="form-input" placeholder="e.g., 120" required>
                                </div>
                                <div>
                                    <label for="dbp" class="field-label">Diastolic BP (mm Hg)</label>
                                    <input type="number" id="dbp" min="0" class="form-input" placeholder="e.g., 70" required>
                                </div>
                            </div>
                        </li>

                        <li class="step-card">
                            <div class="step-header">
                                <span class="step-index">4</span>
                                <div>
                                    <h3>Laboratory data</h3>
                                    <p class="helper-text">Use the most abnormal lab values in the first 24 hours.</p>
                                </div>
                            </div>
                            <div class="grid md:grid-cols-2 gap-6 mt-4">
                                <div>
                                    <label for="sodium" class="field-label">Sodium</label>
                                    <div class="field-combo mt-1">
                                        <input type="number" id="sodium" step="any" class="combo-input" placeholder="e.g., 138" required>
                                        <select id="sodium-unit" class="combo-select">
                                            <option value="mmol/L">mmol/L</option>
                                            <option value="mEq/L">mEq/L</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label for="potassium" class="field-label">Potassium</label>
                                    <div class="field-combo mt-1">
                                        <input type="number" id="potassium" step="any" class="combo-input" placeholder="e.g., 4.2" required>
                                        <select id="potassium-unit" class="combo-select">
                                            <option value="mmol/L">mmol/L</option>
                                            <option value="mEq/L">mEq/L</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label for="creatinine" class="field-label">Creatinine</label>
                                    <div class="field-combo mt-1">
                                        <input type="number" id="creatinine" step="any" class="combo-input" placeholder="e.g., 1.2" required>
                                        <select id="creatinine-unit" class="combo-select">
                                            <option value="mg/dL">mg/dL</option>
                                            <option value="µmol/L">µmol/L</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <label for="hematocrit" class="field-label">Hematocrit (%)</label>
                                    <input type="number" id="hematocrit" min="0" max="100" step="any" class="form-input" placeholder="e.g., 35" required>
                                </div>
                                <div>
                                    <label for="wbc" class="field-label">White blood cells</label>
                                    <div class="field-combo mt-1">
                                        <input type="number" id="wbc" step="1" class="combo-input" placeholder="cells per selected volume" required>
                                        <select id="wbc-unit" class="combo-select">
                                            <option value="µL">per µL</option>
                                            <option value="mL">per mL</option>
                                            <option value="L">per L</option>
                                        </select>
                                    </div>
                                    <p class="helper-text">Enter actual count (e.g., 10000 per µL, not “10”).</p>
                                </div>
                            </div>
                        </li>
                    </ol>

                    <div class="form-actions">
                        <button id="calculate-btn" type="submit" class="primary-button" data-label="Calculate APACHE II">
                            Calculate APACHE II
                        </button>
                    </div>
                </form>
            </section>

            <aside class="layout-secondary sticky-panel">
                <div class="sidebar-card">
                    <p class="badge badge--outline mb-2">Guidance</p>
                    <ul class="info-list">
                        <li>Use the most deranged values within the first 24 hours.</li>
                        <li>Switch between PaO₂ and A–a gradient based on FiO₂.</li>
                        <li>Return only the numeric score in the final answer.</li>
                    </ul>
                </div>
            </aside>
        </div>

        <section id="result-container" class="result-panel hidden">
            <div class="result-header">
                <p class="badge badge--neutral">APACHE II</p>
                <h2>Result</h2>
            </div>
            <p id="result-meta" class="result-subtitle">APACHE II score interpretation.</p>
            <div class="result-value">
                <span class="result-unit">score</span>
                <p id="result-value">—</p>
            </div>
            <details id="result-explanation-panel" class="result-details hidden">
                <summary>View explanation</summary>
                <pre id="result-explanation" class="whitespace-pre-wrap"></pre>
            </details>
        </section>
    </div>

    <script src="./static/js/calculator-page.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiBase = (window.CALCULATOR_API_BASE || '').replace(/\/$/, '');
            const fio2Input = document.getElementById('fio2');
            const pao2Field = document.getElementById('paO2');
            const gradientField = document.getElementById('aa-gradient');
            const ofiYes = document.getElementById('ofi-yes');
            const ofiNo = document.getElementById('ofi-no');
            const surgeryWrapper = document.getElementById('surgery-type-wrapper');
            const resultContainer = document.getElementById('result-container');
            const resultValue = document.getElementById('result-value');
            const resultExplanation = document.getElementById('result-explanation');
            const resultExplanationPanel = document.getElementById('result-explanation-panel');
            const temperatureInput = document.getElementById('temperature');
            const temperatureUnitInput = document.getElementById('temperature-unit');
            const temperatureUnitButtons = document.querySelectorAll('[data-temperature-unit]');

            const setupTemperatureUnitToggle = () => {
                if (!temperatureInput || !temperatureUnitInput || !temperatureUnitButtons.length) return;

                const setActiveButton = (unit) => {
                    temperatureUnitButtons.forEach((button) => {
                        const isActive = button.dataset.temperatureUnit === unit;
                        button.classList.toggle('is-active', isActive);
                        button.setAttribute('aria-pressed', String(isActive));
                    });
                };

                const convertTemperature = (value, fromUnit, toUnit) => {
                    if (!Number.isFinite(value) || fromUnit === toUnit) return value;
                    if (fromUnit === 'celsius' && toUnit === 'fahrenheit') {
                        return (value * 9) / 5 + 32;
                    }
                    if (fromUnit === 'fahrenheit' && toUnit === 'celsius') {
                        return ((value - 32) * 5) / 9;
                    }
                    return value;
                };

                const formatTemperature = (value) => {
                    if (!Number.isFinite(value)) return '';
                    const rounded = Math.round(value * 10) / 10;
                    return Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1);
                };

                temperatureUnitButtons.forEach((button) => {
                    button.addEventListener('click', () => {
                        const nextUnit = button.dataset.temperatureUnit;
                        const currentUnit = temperatureUnitInput.value || 'celsius';
                        if (nextUnit === currentUnit) return;

                        const numericValue = parseFloat(temperatureInput.value);
                        if (Number.isFinite(numericValue)) {
                            const converted = convertTemperature(numericValue, currentUnit, nextUnit);
                            temperatureInput.value = formatTemperature(converted);
                        }

                        temperatureUnitInput.value = nextUnit;
                        setActiveButton(nextUnit);
                    });
                });

                setActiveButton(temperatureUnitInput.value || 'celsius');
            };

            setupTemperatureUnitToggle();

            const toggleOxygenFields = () => {
                const fio2 = parseFloat(fio2Input.value);
                const useGradient = Number.isFinite(fio2) && fio2 >= 50;
                pao2Field.parentElement.classList.toggle('hidden', useGradient);
                gradientField.parentElement.classList.toggle('hidden', !useGradient);
            };

            fio2Input.addEventListener('input', toggleOxygenFields);
            toggleOxygenFields();

            const toggleSurgery = () => {
                const needsSurgery = document.querySelector('input[name="ofi"]:checked')?.value === 'true';
                surgeryWrapper.classList.toggle('hidden', !needsSurgery);
            };

            ofiYes.addEventListener('change', toggleSurgery);
            ofiNo.addEventListener('change', toggleSurgery);

            const ensureNumber = (id, label) => {
                const value = parseFloat(document.getElementById(id).value);
                if (!Number.isFinite(value)) throw new Error(label);
                return value;
            };

            const ensureInt = (id, label, min, max) => {
                const value = parseInt(document.getElementById(id).value, 10);
                if (!Number.isFinite(value) || value < min || value > max) throw new Error(label);
                return value;
            };

            const valueWithUnit = (valueId, unitId) => {
                const value = ensureNumber(valueId, valueId);
                const unit = document.getElementById(unitId).value;
                return [value, unit];
            };

            const collectPayload = () => {
                const missing = [];
                const capture = (fn, label) => {
                    try {
                        return fn();
                    } catch {
                        missing.push(label);
                        return null;
                    }
                };

                const payload = {};

                payload.age = [capture(() => ensureNumber('age', 'Age'), 'Age'), 'years'];
                payload.gcs = capture(() => ensureInt('gcs', 'Glasgow Coma Scale', 3, 15), 'Glasgow Coma Scale');
                payload.fio2 = [capture(() => ensureNumber('fio2', 'FiO2'), 'FiO2'), '%'];
                payload.temperature = [
                    capture(() => ensureNumber('temperature', 'Temperature'), 'Temperature'),
                    document.getElementById('temperature-unit').value === 'fahrenheit'
                        ? 'degrees fahrenheit'
                        : 'degrees celsius',
                ];
                payload.sys_bp = [capture(() => ensureNumber('sbp', 'Systolic BP'), 'Systolic BP'), 'mm Hg'];
                payload.dia_bp = [capture(() => ensureNumber('dbp', 'Diastolic BP'), 'Diastolic BP'), 'mm Hg'];
                payload.heart_rate = [capture(() => ensureNumber('heart-rate', 'Heart rate'), 'Heart rate'), 'beats/min'];
                payload.respiratory_rate = [capture(() => ensureNumber('resp-rate', 'Respiratory rate'), 'Respiratory rate'), 'breaths/min'];
                payload.pH = capture(() => ensureNumber('ph', 'Arterial pH'), 'Arterial pH');

                payload.sodium = capture(() => valueWithUnit('sodium', 'sodium-unit'), 'Sodium');
                payload.potassium = capture(() => valueWithUnit('potassium', 'potassium-unit'), 'Potassium');
                payload.creatinine = capture(() => valueWithUnit('creatinine', 'creatinine-unit'), 'Creatinine');
                payload.hematocrit = [capture(() => ensureNumber('hematocrit', 'Hematocrit'), 'Hematocrit'), '%'];
                payload.wbc = capture(() => valueWithUnit('wbc', 'wbc-unit'), 'White blood cells');

                const fio2Value = payload.fio2[0];
                if (Number.isFinite(fio2Value) && fio2Value >= 50) {
                    payload.a_a_gradient = capture(() => ensureNumber('aa-gradient', 'A–a gradient'), 'A–a gradient');
                } else {
                    const pao2 = capture(() => ensureNumber('paO2', 'PaO2'), 'PaO2');
                    payload.pao2 = [pao2, 'mm Hg'];
                }

                const organFailure = document.querySelector('input[name="ofi"]:checked')?.value === 'true';
                payload.organ_failure_immunocompromise = organFailure;
                if (organFailure) {
                    payload.surgery_type = document.getElementById('surgery-type').value;
                }

                payload.acute_renal_failure = document.getElementById('acute-renal').checked;
                payload.chronic_renal_failure = document.getElementById('chronic-renal').checked;

                if (missing.length) {
                    throw new Error(`Please complete: ${missing.join(', ')}`);
                }

                return payload;
            };

            const renderResult = (result) => {
                resultValue.textContent =
                    result.answer === null || typeof result.answer === 'undefined'
                        ? '—'
                        : result.answer;
                if (result.explanation) {
                    resultExplanation.textContent = result.explanation;
                    resultExplanationPanel.classList.remove('hidden');
                } else {
                    resultExplanationPanel.classList.add('hidden');
                }
                resultContainer.classList.remove('hidden');
            };

            CalculatorPage.init({
                formId: 'apache-form',
                submitButtonId: 'calculate-btn',
                errorBoxId: 'error-message',
                errorTextId: 'error-text',
                apiBase,
                slug: 'apache-ii-score',
                collectPayload,
                onResult: renderResult,
            });
        });
    </script>
</body>
</html>

