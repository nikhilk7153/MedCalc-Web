<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Body Weight Tools</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./static/css/calculator.css">
    <style>
        .input-panel {
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            padding: 1.5rem;
            background-color: #f9fafb;
        }
        .result-card {
            border: 1px solid #e5e7eb;
            border-radius: 0.85rem;
            padding: 1rem 1.25rem;
            background-color: #fff;
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen py-10 px-4">
    <div class="calculator-shell mx-auto w-full max-w-6xl space-y-10">
        <header class="page-hero">
            <div class="hero-pills">
                <span class="badge badge--outline">Benchmark mode</span>
                <span class="badge badge--neutral">Body Weight Suite</span>
            </div>
            <h1 class="page-title">Integrated Body Weight Calculators</h1>
            <p class="page-subtitle">
                Capture sex, weight, height, and target BMI (when required) before selecting the calculator. Use the helper text and checklist in the sidebar to keep values consistent across the suite.
            </p>
            <div class="hero-metadata">
                <div>
                    <p class="meta-label">Calculators</p>
                    <p class="meta-value">BMI · IBW · ABW · Target · BSA</p>
                </div>
                <div>
                    <p class="meta-label">Inputs</p>
                    <p class="meta-value">Sex · weight · multiple height modes</p>
                </div>
                <div>
                    <p class="meta-label">Units</p>
                    <p class="meta-value">kg/lbs + cm/m/ft-in</p>
                </div>
            </div>
        </header>

        <div class="split-layout">
            <section class="layout-primary">
                <div class="callout callout-info">
                    <div class="callout-header">
                        <span class="badge badge--neutral">Checklist</span>
                        <h2>Before running a calculator</h2>
                    </div>
                    <ul class="callout-list">
                        <li>Align all units with the chart—do not convert manually.</li>
                        <li>Confirm whether target BMI is required (Target Weight only).</li>
                        <li>Document height using a single method (metric or ft/in).</li>
                    </ul>
                </div>

        <section class="input-panel space-y-6">
            <form id="body-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Calculator</label>
                    <select id="calculator-select" class="form-input">
                        <option value="body-mass-index-bmi">Body Mass Index</option>
                        <option value="ideal-body-weight">Ideal Body Weight</option>
                        <option value="adjusted-body-weight">Adjusted Body Weight</option>
                        <option value="target-weight">Target Weight</option>
                        <option value="body-surface-area-calculator">Body Surface Area</option>
                    </select>
                </div>
                <div class="grid md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sex</label>
                        <div class="radio-toggle">
                            <input type="radio" id="sex-male" name="sex" value="male" required>
                            <label for="sex-male">Male</label>
                            <input type="radio" id="sex-female" name="sex" value="female">
                            <label for="sex-female">Female</label>
                        </div>
                    </div>
                    <div>
                        <label for="weight-value" class="block text-sm font-medium text-gray-700">Weight</label>
                        <div class="unit-input-group mt-1">
                            <div class="field-combo">
                                <input type="number" id="weight-value" step="0.1" min="1" class="combo-input" placeholder="e.g., 72" required>
                            </div>
                            <input type="hidden" id="weight-unit" value="kg">
                            <div class="unit-toggle" role="group" aria-label="Weight units">
                                <button type="button" class="unit-chip is-active" data-weight-unit="kg" aria-pressed="true">kg</button>
                                <button type="button" class="unit-chip" data-weight-unit="lbs" aria-pressed="false">lbs</button>
                            </div>
                        </div>
                    </div>
                    <div id="target-bmi-wrapper" class="hidden">
                        <label for="target-bmi" class="block text-sm font-medium text-gray-700">Target BMI</label>
                        <input type="number" id="target-bmi" step="0.1" min="10" max="50" class="form-input" placeholder="e.g., 22" value="22">
                        <p class="helper-text">Used for target-weight output.</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Height input mode</label>
                    <select id="height-mode" class="form-input w-full">
                        <option value="cm">Centimeters</option>
                        <option value="m">Meters</option>
                        <option value="ft-in">Feet + inches</option>
                    </select>
                    <div id="height-metric" class="mt-3">
                        <input type="number" id="height-metric-value" step="any" min="0.01" class="form-input" placeholder="e.g., 175" required>
                    </div>
                    <div id="height-ftin" class="mt-3 hidden">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="height-ft" min="0" step="1" class="form-input" placeholder="ft">
                            <input type="number" id="height-in" min="0" step="1" class="form-input" placeholder="in">
                        </div>
                        <p class="helper-text">Enter both feet and inches.</p>
                    </div>
                </div>

                <div class="pt-2">
                    <button id="calculate-btn" type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-2xl shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition">
                        Run Calculators
                    </button>
                </div>
            </form>
        </section>

        <section>
            <div id="result-card" class="result-card">
                <h3 id="result-title" class="text-sm font-semibold text-gray-700">Result</h3>
                <p id="result-value" class="text-3xl font-bold text-gray-900 mt-2">—</p>
                <p id="result-unit" class="text-sm text-gray-500 mt-1">—</p>
            </div>
        </section>
            </section>

            <aside class="layout-secondary sticky-panel">
                <div class="sidebar-card">
                    <p class="badge badge--outline mb-2">Guidance</p>
                    <h3>Sex & weight tips</h3>
                    <ul class="info-list">
                        <li>Sex selector is binary to align with legacy formulas.</li>
                        <li>Weight entry accepts kg or lbs—pick whichever is charted.</li>
                        <li>For Target Weight, provide a goal BMI between 10 and 50.</li>
                    </ul>
                </div>
                <div class="sidebar-card">
                    <h3>Height entry</h3>
                    <ul class="info-list">
                        <li>Metric mode stores a single numeric value.</li>
                        <li>Feet/inches mode requires both fields.</li>
                        <li>Switching modes automatically resets requirements.</li>
                    </ul>
                </div>
                <div class="sidebar-card">
                    <h3>Before you submit</h3>
                    <ol class="steps-list">
                        <li>Confirm the calculator selector matches the benchmark row.</li>
                        <li>Verify the checklist items above the form.</li>
                        <li>Return only the numeric result in the requested unit.</li>
                    </ol>
                </div>
            </aside>
        </div>
    </div>

    <script src="./static/js/calculator-page.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiBase = (window.CALCULATOR_API_BASE || '').replace(/\/$/, '');
            const heightMode = document.getElementById('height-mode');
            const metricWrapper = document.getElementById('height-metric');
            const ftInWrapper = document.getElementById('height-ftin');
            const calculatorSelect = document.getElementById('calculator-select');
            const targetBmiWrapper = document.getElementById('target-bmi-wrapper');
            const targetBmiInput = document.getElementById('target-bmi');
            const resultTitle = document.getElementById('result-title');
            const resultValue = document.getElementById('result-value');
            const resultUnit = document.getElementById('result-unit');
            const weightInput = document.getElementById('weight-value');
            const weightUnitInput = document.getElementById('weight-unit');
            const weightUnitButtons = document.querySelectorAll('[data-weight-unit]');
            const slugMeta = {
                'body-mass-index-bmi': { title: 'Body Mass Index', unit: 'kg/m²' },
                'ideal-body-weight': { title: 'Ideal Body Weight', unit: 'kg' },
                'adjusted-body-weight': { title: 'Adjusted Body Weight', unit: 'kg' },
                'target-weight': { title: 'Target Weight', unit: 'kg' },
                'body-surface-area-calculator': { title: 'Body Surface Area', unit: 'm²' },
            };

            const setupWeightUnitToggle = () => {
                if (!weightInput || !weightUnitInput || !weightUnitButtons.length) return;

                const setActiveButton = (unit) => {
                    weightUnitButtons.forEach((button) => {
                        const isActive = button.dataset.weightUnit === unit;
                        button.classList.toggle('is-active', isActive);
                        button.setAttribute('aria-pressed', String(isActive));
                    });
                };

                const convertWeight = (value, fromUnit, toUnit) => {
                    if (!Number.isFinite(value) || fromUnit === toUnit) return value;
                    const factor = 2.2046226218;
                    if (fromUnit === 'kg' && toUnit === 'lbs') {
                        return value * factor;
                    }
                    if (fromUnit === 'lbs' && toUnit === 'kg') {
                        return value / factor;
                    }
                    return value;
                };

                const formatWeight = (value) => {
                    if (!Number.isFinite(value)) return '';
                    const rounded = Math.round(value * 100) / 100;
                    return Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(2);
                };

                weightUnitButtons.forEach((button) => {
                    button.addEventListener('click', () => {
                        const nextUnit = button.dataset.weightUnit;
                        const currentUnit = weightUnitInput.value || 'kg';
                        if (nextUnit === currentUnit) return;

                        const numericValue = parseFloat(weightInput.value);
                        if (Number.isFinite(numericValue)) {
                            const converted = convertWeight(numericValue, currentUnit, nextUnit);
                            weightInput.value = formatWeight(converted);
                        }

                        weightUnitInput.value = nextUnit;
                        setActiveButton(nextUnit);
                    });
                });

                setActiveButton(weightUnitInput.value || 'kg');
            };

            setupWeightUnitToggle();

            const updateHeightMode = () => {
                const mode = heightMode.value;
                metricWrapper.classList.toggle('hidden', mode === 'ft-in');
                ftInWrapper.classList.toggle('hidden', mode !== 'ft-in');
                const metricInput = document.getElementById('height-metric-value');
                if (mode === 'ft-in') {
                    metricInput.removeAttribute('required');
                    document.getElementById('height-ft').setAttribute('required', 'required');
                    document.getElementById('height-in').setAttribute('required', 'required');
                } else {
                    metricInput.setAttribute('required', 'required');
                    document.getElementById('height-ft').removeAttribute('required');
                    document.getElementById('height-in').removeAttribute('required');
                }
            };

            heightMode.addEventListener('change', updateHeightMode);
            updateHeightMode();

            const ensureNumber = (id, label) => {
                const value = parseFloat(document.getElementById(id).value);
                if (!Number.isFinite(value)) throw new Error(label);
                return value;
            };

            const buildHeightPayload = () => {
                const mode = heightMode.value;
                if (mode === 'cm') {
                    return [ensureNumber('height-metric-value', 'Height'), 'cm'];
                }
                if (mode === 'm') {
                    return [ensureNumber('height-metric-value', 'Height'), 'm'];
                }
                const feet = ensureNumber('height-ft', 'Height (ft)');
                const inches = ensureNumber('height-in', 'Height (in)');
                return [feet, 'ft', inches, 'in'];
            };

            const getSex = () => {
                const radio = document.querySelector('input[name="sex"]:checked');
                if (!radio) throw new Error('Sex');
                return radio.value === 'male' ? 'Male' : 'Female';
            };

            const updateTargetBmiVisibility = () => {
                targetBmiWrapper.classList.toggle('hidden', calculatorSelect.value !== 'target-weight');
                if (calculatorSelect.value === 'target-weight') {
                    targetBmiInput.setAttribute('required', 'required');
                } else {
                    targetBmiInput.removeAttribute('required');
                }
            };
            calculatorSelect.addEventListener('change', updateTargetBmiVisibility);
            updateTargetBmiVisibility();

            const collectPayload = () => {
                const payload = {
                    weight: [ensureNumber('weight-value', 'Weight'), document.getElementById('weight-unit').value],
                    height: buildHeightPayload(),
                    sex: getSex(),
                };

                if (!payload.height) {
                    throw new Error('Please complete height details.');
                }

                if (calculatorSelect.value === 'target-weight') {
                    const targetBmi = parseFloat(targetBmiInput.value);
                    if (!Number.isFinite(targetBmi)) {
                        throw new Error('Target BMI');
                    }
                    payload.body_mass_index = [targetBmi, 'kg/m^2'];
                }

                return payload;
            };

            CalculatorPage.init({
                formId: 'body-form',
                submitButtonId: 'calculate-btn',
                errorBoxId: 'error-message',
                errorTextId: 'error-text',
                apiBase,
                getEndpoint: () => `${apiBase}/api/calculators/${calculatorSelect.value}`,
                collectPayload,
                onResult: (result) => {
                    const meta = slugMeta[calculatorSelect.value] || { title: 'Result', unit: '—' };
                    resultTitle.textContent = meta.title;
                    const value = result.answer ?? result.raw_score ?? result.score;
                    resultValue.textContent =
                        value === null || typeof value === 'undefined'
                            ? '—'
                            : (typeof value === 'number'
                                ? (Number.isInteger(value) ? value : value.toFixed(2))
                                : value);
                    resultUnit.textContent = meta.unit;
                },
            });
        });
    </script>
</body>
</html>

